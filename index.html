<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½è‰²å¡å·¥åŠ v6.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --text: #1e293b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
        }

        body {
            font-family: "Segoe UI Emoji", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 100px;
        }

        /* === å¤´éƒ¨ === */
        .header-container {
            width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        .title-group h1 { margin: 0; color: #0f172a; font-size: 24px; }
        .title-group .subtitle { color: #64748b; margin: 5px 0 0 0; font-size: 13px; }

        /* === è¯­è¨€èœå• === */
        .lang-dropdown { position: relative; z-index: 1000; }
        .lang-btn {
            background: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 20px;
            cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;
        }
        .lang-menu {
            display: none; position: absolute; right: 0; top: 115%; background: white; min-width: 160px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 12px; border: 1px solid var(--border); overflow: hidden;
        }
        .lang-menu.show { display: block; }
        .lang-menu a { padding: 12px 15px; display: block; color: var(--text); text-decoration: none; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
        
        /* === æ“ä½œæ  (ç§»åŠ¨ç«¯ä¼˜åŒ–) === */
        .action-bar {
            display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 15px;
            border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); flex-wrap: wrap;
            width: 100%; max-width: 1000px; box-sizing: border-box;
        }
        .btn {
            padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px; flex: 1; min-width: 120px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: #334155; }
        .btn-red { background: #fee2e2; color: #b91c1c; }
        .divider { width: 1px; background: var(--border); margin: 0 5px; display: none; } /* ç§»åŠ¨ç«¯éšè—åˆ†å‰²çº¿ */

        @media (min-width: 768px) {
            .divider { display: block; }
            .btn { flex: initial; }
        }

        /* === æ§åˆ¶é¢æ¿ === */
        .control-panel {
            background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 1000px;
            margin-bottom: 20px; display: flex; gap: 30px; flex-wrap: wrap; box-sizing: border-box;
        }
        .control-group { flex: 1; min-width: 280px; }
        .control-label { font-weight: 700; font-size: 14px; margin-bottom: 15px; display: block; color: #334155; }
        
        input[type=range] { width: 100%; height: 20px; accent-color: var(--primary); margin-bottom: 20px; } /* åŠ å¤§è§¦æ‘¸åŒºåŸŸ */

        /* === ç”»å»Šä¸å¡ç‰‡ === */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; width: 100%; max-width: 1600px; }
        
        @media (max-width: 400px) {
            .gallery { grid-template-columns: 1fr; }
        }

        .card {
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
        .name-input { border: 1px solid transparent; font-size: 14px; font-weight: 600; color: #334151; width: 100%; padding: 6px; border-radius: 4px; background: #f8fafc; }
        .name-input:focus { border-color: var(--primary); background: #fff; outline: none; }

        .toolbar { display: flex; gap: 8px; }
        .tool-btn {
            border: 1px solid var(--border); background: white; color: #64748b;
            padding: 6px 10px; border-radius: 6px; font-size: 14px;
        }
        
        .original-img { width: 100%; height: 160px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; display: none; border: 1px solid var(--border); }
        canvas { width: 100%; height: auto; border-radius: 8px; margin-bottom: 12px; border: 1px solid #f1f5f9; }

        /* === ä¸‹è½½æŒ‰é’® (ä¿®å¤) === */
        .download-card-btn {
            display: block; width: 100%; padding: 12px; background: var(--success); color: white;
            text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;
            box-sizing: border-box; cursor: pointer;
        }
        .download-card-btn:active { background: #059669; }

        /* === ä¸Šä¼ åŒº === */
        .upload-area {
            width: 100%; max-width: 1000px; border: 2px dashed var(--border); border-radius: 12px; padding: 40px 20px;
            text-align: center; background: white; margin-bottom: 30px; box-sizing: border-box;
        }

        /* === æ ‡ç­¾ === */
        .tags-area { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px; border: 1px solid var(--border); }

        #backToTop {
            position: fixed; bottom: 30px; right: 20px; width: 45px; height: 45px;
            background: var(--primary); color: white; border-radius: 50%; border: none;
            font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; pointer-events: none; transition: 0.3s;
            z-index: 999;
        }
        #backToTop.visible { opacity: 1; pointer-events: auto; }

    </style>
</head>
<body>

    <div class="header-container">
        <div class="title-group">
            <h1 data-i18n="mainTitle">ğŸ¨ å…¨èƒ½è‰²å¡å·¥åŠ v6.2</h1>
            <p class="subtitle" data-i18n="subTitle">PC / æ‰‹æœºç«¯å®Œç¾é€‚é… | é•¿æŒ‰ä¿å­˜ | å¤šè¯­è¨€</p>
        </div>
        
        <div class="lang-dropdown">
            <button class="lang-btn" onclick="toggleLangMenu(event)">
                ğŸŒ <span data-i18n="langLabel">ç®€ä½“ä¸­æ–‡</span> â–¼
            </button>
            <div class="lang-menu" id="langMenu">
                <a onclick="selectLanguage('zh-CN')">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</a>
                <a onclick="selectLanguage('zh-TW')">ğŸ‡¨ğŸ‡³ ç¹é«”ä¸­æ–‡</a>
                <a onclick="selectLanguage('en')">ğŸ‡ºğŸ‡¸ English</a>
                <a onclick="selectLanguage('ja')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</a>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <button class="btn btn-blue" onclick="document.getElementById('copaInput').click()">ğŸ“‚ <span data-i18n="btnImport">å¯¼å…¥æ–¹æ¡ˆ</span></button>
        <button class="btn btn-outline" onclick="saveProject()">ğŸ’¾ <span data-i18n="btnSave">ä¿å­˜æ–¹æ¡ˆ</span></button>
        <div class="divider"></div>
        <button class="btn btn-outline" id="btnBrowse" onclick="selectExportFolder()">ğŸ“ <span data-i18n="btnBrowse">æµè§ˆä½ç½®</span></button>
        <button class="btn btn-green" onclick="exportAll()">â¬‡ï¸ <span data-i18n="btnExport">å…¨éƒ¨å¯¼å‡º</span></button>
        <div class="divider"></div>
        <button class="btn btn-red" onclick="clearAll()">ğŸ—‘ï¸ <span data-i18n="btnClear">æ¸…ç©º</span></button>
        <input type="file" id="copaInput" accept=".copa" style="display:none" onchange="loadProject(this)">
    </div>
    
    <div style="font-size:12px; color:#6b7280; margin-bottom:15px; text-align:center; padding:0 10px;" id="pathDisplay" data-i18n="pathDefault">
        é»˜è®¤å¯¼å‡ºè·¯å¾„: æµè§ˆå™¨ä¸‹è½½æ–‡ä»¶å¤¹ (æˆ–ç›¸å†Œ)
    </div>

    <div class="control-panel">
        <div class="control-group">
            <span class="control-label" data-i18n="secParams">âš™ï¸ å…¨å±€å‚æ•°</span>
            <div class="slider-row"><span data-i18n="lblCount">æå–æ•°é‡</span><span id="lblCount">8</span></div>
            <input type="range" id="inCount" min="5" max="20" value="8">

            <div class="slider-row"><span data-i18n="lblPct">æœ€å°å æ¯”é˜ˆå€¼</span><span id="lblPct">0.5%</span></div>
            <input type="range" id="inPct" min="0.1" max="20" step="0.1" value="0.5">
        </div>

        <div class="control-group">
            <span class="control-label" data-i18n="secExclude">ğŸš« å…¨å±€èƒŒæ™¯æ’é™¤</span>
            <div style="display:flex; gap:10px;">
                <input type="color" id="inColorPick" value="#FFFFFF" style="height:40px; width:50px; border:none;">
                <input type="text" id="inColorTxt" value="#FFFFFF" maxlength="7" style="width:80px; border:1px solid #ddd; border-radius:6px; padding:5px; text-align:center;">
                <button class="btn btn-blue" style="flex:1;" onclick="addGlobalExclude()"><span data-i18n="btnAdd">æ·»åŠ </span></button>
            </div>
            <div class="tags-area" id="globalTags"></div>
        </div>
    </div>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()" id="dropZone">
        <h3 style="margin:0 0 8px 0; color:#374151;" data-i18n="uploadTitle">ğŸ“¤ ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</h3>
        <div style="font-size:12px; color:#9ca3af;" data-i18n="uploadDesc">æ”¯æŒæ‰¹é‡ â€¢ è‡ªåŠ¨é€‚é…æ‰‹æœºç›¸å†Œ</div>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
    </div>

    <div class="gallery" id="gallery"></div>

    <button id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">â¬†</button>

    <script>
        // === å›½é™…åŒ– (i18n) ===
        const translations = {
            'zh-CN': {
                mainTitle: 'ğŸ¨ å…¨èƒ½è‰²å¡å·¥åŠ v6.2', subTitle: 'PC / æ‰‹æœºç«¯å®Œç¾é€‚é… | é•¿æŒ‰ä¿å­˜ | å¤šè¯­è¨€', langLabel: 'ç®€ä½“ä¸­æ–‡',
                btnImport: 'å¯¼å…¥æ–¹æ¡ˆ', btnSave: 'ä¿å­˜ (.copa)', btnBrowse: 'æµè§ˆä½ç½®', btnExport: 'å…¨éƒ¨å¯¼å‡º', btnClear: 'æ¸…ç©º',
                pathDefault: 'é»˜è®¤å¯¼å‡ºè·¯å¾„: æµè§ˆå™¨ä¸‹è½½æ–‡ä»¶å¤¹', pathSelected: 'âœ… å¯¼å‡ºä½ç½®: ',
                secParams: 'âš™ï¸ å…¨å±€å‚æ•°', lblCount: 'æå–æ•°é‡', lblPct: 'æœ€å°å æ¯”é˜ˆå€¼',
                secExclude: 'ğŸš« å…¨å±€èƒŒæ™¯æ’é™¤', btnAdd: 'æ·»åŠ ',
                uploadTitle: 'ğŸ“¤ ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡', uploadDesc: 'æ”¯æŒæ‰¹é‡ â€¢ è‡ªåŠ¨é€‚é…æ‰‹æœºç›¸å†Œ',
                btnDownloadCard: 'ğŸ“¥ ä¿å­˜è‰²å¡åˆ°ç›¸å†Œ', tipName: 'è¾“å…¥ç©ºæ ¼éšè—æ ‡é¢˜', ratio: 'å æ¯”: ', empty: 'é¢œè‰²è¢«æ’é™¤',
                msgClear: 'âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰è‰²å¡å—ï¼Ÿ', iosTip: 'ğŸ“± iOSç”¨æˆ·è¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜'
            },
            'zh-TW': {
                mainTitle: 'ğŸ¨ å…¨èƒ½è‰²å¡å·¥åŠ v6.2', subTitle: 'PC / æ‰‹æ©Ÿç«¯å®Œç¾é©é… | é•·æŒ‰ä¿å­˜ | å¤šèªè¨€', langLabel: 'ç¹é«”ä¸­æ–‡',
                btnImport: 'å°å…¥æ–¹æ¡ˆ', btnSave: 'ä¿å­˜ (.copa)', btnBrowse: 'ç€è¦½ä½ç½®', btnExport: 'å…¨éƒ¨å°å‡º', btnClear: 'æ¸…ç©º',
                pathDefault: 'é»˜èªå°å‡ºè·¯å¾‘: ç€è¦½å™¨ä¸‹è¼‰æ–‡ä»¶å¤¾', pathSelected: 'âœ… å°å‡ºä½ç½®: ',
                secParams: 'âš™ï¸ å…¨å±€åƒæ•¸', lblCount: 'æå–æ•¸é‡', lblPct: 'æœ€å°å æ¯”é–¾å€¼',
                secExclude: 'ğŸš« å…¨å±€èƒŒæ™¯æ’é™¤', btnAdd: 'æ·»åŠ ',
                uploadTitle: 'ğŸ“¤ é»æ“Šä¸Šå‚³åœ–ç‰‡', uploadDesc: 'æ”¯æŒæ‰¹é‡ â€¢ è‡ªå‹•é©é…æ‰‹æ©Ÿç›¸å†Š',
                btnDownloadCard: 'ğŸ“¥ ä¿å­˜è‰²å¡åˆ°ç›¸å†Š', tipName: 'è¼¸å…¥ç©ºæ ¼éš±è—æ¨™é¡Œ', ratio: 'å æ¯”: ', empty: 'é¡è‰²è¢«æ’é™¤',
                msgClear: 'âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è‰²å¡å—ï¼Ÿ', iosTip: 'ğŸ“± iOSç”¨æˆ¶è«‹é•·æŒ‰åœ–ç‰‡ä¿å­˜'
            },
            'en': {
                mainTitle: 'ğŸ¨ Color Studio v6.2', subTitle: 'Mobile Optimized | Batch Export | Multi-language', langLabel: 'English',
                btnImport: 'Import', btnSave: 'Save', btnBrowse: 'Folder', btnExport: 'Export All', btnClear: 'Clear',
                pathDefault: 'Default Path: Downloads Folder', pathSelected: 'âœ… Path: ',
                secParams: 'âš™ï¸ Settings', lblCount: 'Count', lblPct: 'Threshold',
                secExclude: 'ğŸš« Exclude', btnAdd: 'Add',
                uploadTitle: 'ğŸ“¤ Upload Images', uploadDesc: 'Batch Support â€¢ Mobile Friendly',
                btnDownloadCard: 'ğŸ“¥ Save to Photos', tipName: 'Space to hide title', ratio: 'Ratio: ', empty: 'No Colors',
                msgClear: 'âš ï¸ Clear all palettes?', iosTip: 'ğŸ“± Long press image to save'
            },
            'ja': {
                mainTitle: 'ğŸ¨ ã‚«ãƒ©ãƒ¼ã‚¹ã‚¿ã‚¸ã‚ª v6.2', subTitle: 'ã‚¹ãƒãƒ›å¯¾å¿œ | ä¸€æ‹¬ä¿å­˜ | å¤šè¨€èª', langLabel: 'æ—¥æœ¬èª',
                btnImport: 'èª­è¾¼', btnSave: 'ä¿å­˜', btnBrowse: 'ä¿å­˜å…ˆ', btnExport: 'ä¸€æ‹¬å‡ºåŠ›', btnClear: 'å…¨å‰Šé™¤',
                pathDefault: 'ä¿å­˜å…ˆ: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€', pathSelected: 'âœ… å‡ºåŠ›å…ˆ: ',
                secParams: 'âš™ï¸ è¨­å®š', lblCount: 'æŠ½å‡ºæ•°', lblPct: 'æœ€å°æ¯”ç‡',
                secExclude: 'ğŸš« é™¤å¤–è‰²', btnAdd: 'è¿½åŠ ',
                uploadTitle: 'ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', uploadDesc: 'ä¸€æ‹¬å¯¾å¿œ â€¢ ã‚¹ãƒãƒ›æœ€é©åŒ–',
                btnDownloadCard: 'ğŸ“¥ ç”»åƒã‚’ä¿å­˜', tipName: 'ç©ºç™½ã§ã‚¿ã‚¤ãƒˆãƒ«éè¡¨ç¤º', ratio: 'æ¯”ç‡: ', empty: 'é™¤å¤–ã•ã‚Œã¾ã—ãŸ',
                msgClear: 'âš ï¸ å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', iosTip: 'ğŸ“± ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜'
            }
        };

        const state = { lang: 'zh-CN', count: 8, minPct: 0.5, globalExclusions: [{ hex: '#FFFFFF', ...hexToRgb('#FFFFFF') }], cards: [], directoryHandle: null };

        // === è¯­è¨€åˆ‡æ¢ ===
        function toggleLangMenu(e) { e.stopPropagation(); document.getElementById('langMenu').classList.toggle('show'); }
        window.onclick = (e) => { if(!e.target.matches('.lang-btn')) document.getElementById('langMenu').classList.remove('show'); };
        
        function selectLanguage(lang) {
            state.lang = lang;
            const t = translations[lang];
            document.querySelector('.lang-btn span').innerText = t.langLabel;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                if (t[el.dataset.i18n]) el.innerText = t[el.dataset.i18n];
            });
            document.querySelectorAll('.name-input').forEach(i => i.title = t.tipName);
            state.cards.forEach(c => {
                // æ›´æ–°ä¸‹è½½æŒ‰é’®æ–‡å­—
                c.container.querySelector('.download-card-btn').innerText = t.btnDownloadCard;
                c.render();
            });
        }
        function getT(key) { return translations[state.lang][key]; }

        // === æ ¸å¿ƒé€»è¾‘ ===
        class PaletteCard {
            constructor(imgSrc, filename, customName = "", localExclusions = []) {
                this.imgSrc = imgSrc; this.filename = filename; this.customName = customName; this.localExclusions = localExclusions;
                this.showOriginal = false; this.chartType = 'list';
                this.img = new Image(); this.img.src = imgSrc;
                this.img.onload = () => { this.createDOM(); state.cards.push(this); this.render(); }
            }

            createDOM() {
                const div = document.createElement('div'); div.className = 'card';
                div.innerHTML = `
                    <div class="card-header">
                        <input type="text" class="name-input" value="${this.customName}" placeholder="${this.filename}" title="${getT('tipName')}">
                        <div class="toolbar">
                            <button class="tool-btn" id="btnImg">ğŸ‘ï¸</button>
                            <button class="tool-btn" id="btnChart">ğŸ“Š</button>
                            <button class="tool-btn" id="btnUndo">â†©ï¸</button>
                            <button class="tool-btn" id="btnDel" style="color:#ef4444">Ã—</button>
                        </div>
                    </div>
                    <img src="${this.imgSrc}" class="original-img">
                    <canvas></canvas>
                    <a class="download-card-btn" onclick="downloadSingle(this)">${getT('btnDownloadCard')}</a>
                `;
                this.container = div; this.canvas = div.querySelector('canvas');
                this.inputName = div.querySelector('.name-input');
                this.inputName.addEventListener('input', e => { this.customName = e.target.value; this.render(); });
                div.querySelector('#btnDel').onclick = () => this.remove();
                div.querySelector('#btnUndo').onclick = () => { if(this.localExclusions.length){ this.localExclusions.pop(); this.render(); }};
                div.querySelector('#btnImg').onclick = (e) => { this.showOriginal = !this.showOriginal; div.querySelector('.original-img').style.display = this.showOriginal ? 'block':'none'; e.target.classList.toggle('active'); };
                div.querySelector('#btnChart').onclick = (e) => { this.chartType = this.chartType === 'list' ? 'pie':'list'; this.render(); e.target.classList.toggle('active'); };
                this.canvas.addEventListener('click', e => this.handleClick(e));
                document.getElementById('gallery').prepend(div);
            }

            remove() { this.container.remove(); state.cards = state.cards.filter(c => c !== this); }

            handleClick(e) {
                if(!this.currentColors) return;
                const rect = this.canvas.getBoundingClientRect();
                const y = (e.clientY - rect.top) * (this.canvas.width / rect.width);
                const headH = this.customName !== ' ' ? 40 : 0;
                if(y < headH) return;
                let idx = this.chartType === 'list' ? Math.floor((y-headH)/50) : (y-headH > 320 ? Math.floor((y-headH-320)/40) : -1);
                if(idx >= 0 && idx < this.currentColors.length) {
                    const c = this.currentColors[idx];
                    this.localExclusions.push({ hex: c.hex, ...hexToRgb(c.hex) });
                    this.render();
                }
            }

            getDisplayName() { return this.customName.trim() || this.filename; }

            render() {
                const allEx = [...state.globalExclusions, ...this.localExclusions];
                this.currentColors = getDominantColors(this.img, state.count, state.minPct, allEx);
                this.container.querySelector('#btnUndo').style.opacity = this.localExclusions.length ? '1':'0.3';
                
                if(this.chartType === 'list') this.renderList(this.currentColors);
                else this.renderPie(this.currentColors);
                
                // æ›´æ–°ä¸‹è½½æŒ‰é’®çš„æ•°æ® (ç”¨äºæ‰‹æœºç«¯ä¿å­˜)
                // æ³¨æ„ï¼šä¸ç›´æ¥è®¾ç½®hrefï¼Œè€Œæ˜¯åœ¨ç‚¹å‡»æ—¶ç”Ÿæˆï¼ŒèŠ‚çœå†…å­˜
                this.container.querySelector('.download-card-btn').dataset.filename = cleanFileName(this.getDisplayName());
            }

            renderList(colors) {
                const ctx = this.canvas.getContext('2d');
                const w = 400, rowH = 50;
                const headH = this.customName !== ' ' ? 40 : 0;
                const h = Math.max(100, colors.length * rowH) + headH;
                this.canvas.width = w; this.canvas.height = h;
                ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h);
                if(headH) { ctx.fillStyle = '#1e293b'; ctx.font = 'bold 18px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(this.getDisplayName(), w/2, headH/2); }
                if(!colors.length) { this.drawEmpty(ctx, w, h); return; }
                colors.forEach((c, i) => {
                    const y = headH + i * rowH;
                    ctx.fillStyle = c.hex; ctx.fillRect(0, y, w * 0.4, rowH);
                    ctx.fillStyle = '#1e293b'; ctx.font = 'bold 16px monospace'; ctx.textAlign = 'left'; ctx.fillText(c.hex, w*0.45, y+rowH/2-8);
                    ctx.fillStyle = '#64748b'; ctx.font = '14px sans-serif'; ctx.fillText(`${getT('ratio')}${c.percentage}`, w*0.45, y+rowH/2+12);
                });
            }

            renderPie(colors) {
                const ctx = this.canvas.getContext('2d');
                const w = 400, pieH = 320, rowH = 40;
                const headH = this.customName !== ' ' ? 40 : 0;
                const h = pieH + colors.length * rowH + headH;
                this.canvas.width = w; this.canvas.height = h;
                ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h);
                if(headH) { ctx.fillStyle = '#1e293b'; ctx.font = 'bold 18px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(this.getDisplayName(), w/2, headH/2); }
                if(!colors.length) { this.drawEmpty(ctx, w, h); return; }
                const cx = w/2, cy = headH + pieH/2, r = 120;
                let start = 0; const total = colors.reduce((s,c)=>s+c.rawPct,0);
                colors.forEach(c => {
                    const ang = (c.rawPct/total)*2*Math.PI;
                    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+ang); ctx.fillStyle=c.hex; ctx.fill(); ctx.strokeStyle='#fff'; ctx.stroke(); start+=ang;
                });
                ctx.beginPath(); ctx.arc(cx,cy,r*0.5,0,2*Math.PI); ctx.fillStyle='#fff'; ctx.fill();
                colors.forEach((c,i) => {
                    const y = headH + pieH + i*rowH;
                    ctx.fillStyle=c.hex; ctx.fillRect(40,y+10,20,20);
                    ctx.fillStyle='#1e293b'; ctx.font='bold 14px monospace'; ctx.textAlign='left'; ctx.fillText(c.hex, 75, y+25);
                    ctx.fillStyle='#f1f5f9'; ctx.fillRect(180,y+14,150,12); ctx.fillStyle=c.hex; ctx.fillRect(180,y+14,150*(c.rawPct/50),12);
                    ctx.fillStyle='#64748b'; ctx.textAlign='right'; ctx.fillText(c.percentage, 380, y+25);
                });
            }

            drawEmpty(ctx, w, h) { ctx.fillStyle = '#94a3b8'; ctx.font = '16px sans-serif'; ctx.textAlign='center'; ctx.fillText(getT('empty'), w/2, h/2); }
        }

        // === ç‹¬ç«‹ä¸‹è½½å¤„ç†å‡½æ•° (é€‚é…ç§»åŠ¨ç«¯) ===
        function downloadSingle(btn) {
            const cardDiv = btn.closest('.card');
            const canvas = cardDiv.querySelector('canvas');
            const filename = btn.dataset.filename || 'palette';
            
            // å°† Canvas è½¬ä¸º DataURL
            const dataUrl = canvas.toDataURL('image/png');

            // æ£€æµ‹æ˜¯å¦ä¸º iOS (iPhone/iPad)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

            if (isIOS) {
                // iOS ç‰¹æ®Šå¤„ç†ï¼šæ— æ³•å¼ºåˆ¶ä¸‹è½½ï¼Œåªèƒ½å¼¹çª—æ˜¾ç¤ºå›¾ç‰‡ä¾›é•¿æŒ‰
                const win = window.open();
                if (win) {
                    win.document.write(`<h2 style="text-align:center;font-family:sans-serif;margin-top:20px;">${getT('iosTip')}</h2><img src="${dataUrl}" style="width:100%;max-width:800px;display:block;margin:0 auto;">`);
                } else {
                    // å¦‚æœå¼¹çª—è¢«æ‹¦æˆªï¼Œç›´æ¥åœ¨å½“å‰é¡µé¢è·³è½¬
                    window.location.href = dataUrl;
                }
            } else {
                // PC å’Œ Androidï¼šä½¿ç”¨æ ‡å‡†çš„ä¸‹è½½é“¾æ¥æ–¹å¼
                const link = document.createElement('a');
                link.download = filename + '.png';
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // === è¾…åŠ©å‡½æ•° ===
        function getDominantColors(img, count, minPct, exclusions) {
            const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
            const scale = Math.min(1, 150/Math.min(img.width,img.height));
            cvs.width = img.width*scale; cvs.height = img.height*scale;
            ctx.drawImage(img,0,0,cvs.width,cvs.height);
            const data = ctx.getImageData(0,0,cvs.width,cvs.height).data;
            const map = {}; let total = 0;
            for(let i=0; i<data.length; i+=16) {
                const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
                if(a<128) continue;
                let skip = false;
                for(let ex of exclusions) if(Math.sqrt((r-ex.r)**2+(g-ex.g)**2+(b-ex.b)**2)<30) {skip=true; break;}
                if(skip) continue;
                total++;
                const q = 20; const key = `${Math.round(r/q)*q},${Math.round(g/q)*q},${Math.round(b/q)*q}`;
                if(!map[key]) map[key] = {c:0, r:Math.round(r/q)*q, g:Math.round(g/q)*q, b:Math.round(b/q)*q};
                map[key].c++;
            }
            return Object.values(map).map(o => {
                const p = (o.c/total)*100;
                return { hex: rgbToHex(o.r, o.g, o.b), rawPct: p, percentage: p.toFixed(1)+'%' };
            }).sort((a,b)=>b.rawPct-a.rawPct).filter(i=>i.rawPct>=minPct).slice(0, count);
        }
        
        function cleanFileName(n) { return n.replace(/[^a-z0-9\u4e00-\u9fa5_\-\.]/gi, '_'); }
        function rgbToHex(r,g,b) { return "#" + ((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).toUpperCase(); }
        function hexToRgb(h) { const n = parseInt(h.replace('#',''), 16); return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }

        // === è®¾ç½®ä¸äº‹ä»¶ ===
        const updateSettings = () => { state.count = inCount.value; state.minPct = inPct.value; lblCount.innerText = state.count; lblPct.innerText = state.minPct+'%'; state.cards.forEach(c=>c.render()); };
        inCount.oninput = updateSettings; inPct.oninput = updateSettings;
        
        const inColorPick = document.getElementById('inColorPick');
        const inColorTxt = document.getElementById('inColorTxt');
        inColorPick.oninput = e => inColorTxt.value = e.target.value.toUpperCase();
        
        function addGlobalExclude() {
            const hex = inColorTxt.value.toUpperCase();
            if(/^#[0-9A-Fa-f]{6}$/.test(hex) && !state.globalExclusions.some(c=>c.hex===hex)) {
                state.globalExclusions.push({hex, ...hexToRgb(hex)}); renderGlobalTags(); state.cards.forEach(c=>c.render());
            }
        }
        function removeGlobal(hex) { state.globalExclusions = state.globalExclusions.filter(c=>c.hex!==hex); renderGlobalTags(); state.cards.forEach(c=>c.render()); }
        function renderGlobalTags() { document.getElementById('globalTags').innerHTML = state.globalExclusions.map(c=>`<div class="tag"><span style="background:${c.hex};width:10px;height:10px;border-radius:50%;border:1px solid #ddd"></span>${c.hex}<span style="cursor:pointer;font-weight:bold" onclick="removeGlobal('${c.hex}')">Ã—</span></div>`).join(''); }
        renderGlobalTags();

        // === æ–‡ä»¶å¤„ç† ===
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#4f46e5'; };
        dropZone.ondragleave = e => { e.preventDefault(); dropZone.style.borderColor = '#e2e8f0'; };
        dropZone.ondrop = e => { e.preventDefault(); dropZone.style.borderColor = '#e2e8f0'; handleFiles(e.dataTransfer.files); };
        fileInput.onchange = e => handleFiles(e.target.files);
        function handleFiles(files) { Array.from(files).forEach(f => { if(f.type.startsWith('image/')) { const r = new FileReader(); r.onload = e => new PaletteCard(e.target.result, f.name); r.readAsDataURL(f); } }); fileInput.value = ''; }

        // === æ‰¹é‡å¯¼å‡º ===
        async function exportAll() {
            if(!state.cards.length) return alert(getT('msgEmptyExport') || "Empty");
            if(state.directoryHandle) {
                for(let c of state.cards) {
                    const blob = await new Promise(r=>c.canvas.toBlob(r));
                    const name = (c.customName===' '?c.filename.split('.')[0]:c.getDisplayName()) + '.png';
                    const fh = await state.directoryHandle.getFileHandle(cleanFileName(name), {create:true});
                    const w = await fh.createWritable(); await w.write(blob); await w.close();
                }
                alert("Success!");
            } else {
                const zip = new JSZip();
                state.cards.forEach(c => {
                    const name = c.customName===' '?c.filename.split('.')[0]:c.getDisplayName();
                    zip.file(cleanFileName(name)+'.png', c.canvas.toDataURL().split(',')[1], {base64:true});
                });
                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = "palettes.zip"; a.click();
            }
        }
        async function selectExportFolder() { if('showDirectoryPicker' in window) { try{ state.directoryHandle = await window.showDirectoryPicker(); document.getElementById('pathDisplay').innerText = getT('pathSelected')+state.directoryHandle.name; }catch(e){} } else alert("Browser not supported"); }
        
        // === ä¿å­˜/åŠ è½½ ===
        function saveProject() {
            const data = JSON.stringify({ version: "6.2", cards: state.cards.map(c=>({ imgSrc:c.imgSrc, filename:c.filename, customName:c.customName, localExclusions:c.localExclusions })) });
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data],{type:"application/json"})); a.download = `project_${new Date().toISOString().slice(0,10)}.copa`; a.click();
        }
        function loadProject(inp) {
            const f = inp.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.cards) { document.getElementById('gallery').innerHTML=''; state.cards=[]; d.cards.forEach(c=>new PaletteCard(c.imgSrc,c.filename,c.customName,c.localExclusions)); }
                } catch(err) { alert("Error"); }
            }; r.readAsText(f); inp.value='';
        }
        function clearAll() { if(confirm(getT('msgClear'))) { document.getElementById('gallery').innerHTML=''; state.cards=[]; } }
        
        // å›åˆ°é¡¶éƒ¨
        window.onscroll = () => document.getElementById('backToTop').classList.toggle('visible', window.scrollY > 300);
    </script>
</body>
</html>
